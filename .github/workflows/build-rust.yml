name: Build on Windows
on:
  workflow_dispatch: # run manually
    branches: ["main"]
  workflow_call:     # can be called by another workflow

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS       : "-Dwarnings"

jobs:
  release-win:
    strategy:
      matrix:
        include:
          - os           : windows-latest
            artifact_dll : ${{github.event.repository.name}}_lib.dll
            asset_dll    : ${{github.event.repository.name}}.dll
            artifact_exe : ${{github.event.repository.name}}.exe
            asset_exe    : ${{github.event.repository.name}}_test.exe
            cargo_target : x86_64-pc-windows-msvc
            cache_key    : x64
          - os           : windows-11-arm
            artifact_dll : ${{github.event.repository.name}}_lib.dll
            asset_dll    : ${{github.event.repository.name}}-arm64.dll
            artifact_exe : ${{github.event.repository.name}}.exe
            asset_exe    : ${{github.event.repository.name}}_test-arm64.exe
            cargo_target : aarch64-pc-windows-msvc
            cache_key    : arm64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8    #v6.0.1 25-12
      - name: Setup Rust cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 #v2.8.2 25-12
        with:
          shared-key: "persist-cross-job-win-${{matrix.cache_key}}"
      - name : Build release
        shell: powershell
        run  : |
          cargo build --release       --target ${{matrix.cargo_target}}
          cargo build --release --lib --target ${{matrix.cargo_target}}
          md asset
          mv target/${{matrix.cargo_target}}/release/${{matrix.artifact_exe}} asset/${{matrix.asset_exe}}.exe
          mv target/${{matrix.cargo_target}}/release/${{matrix.artifact_dll}} asset/${{matrix.asset_dll}}.dll
        # â†‘ useful when introducing features that would generate same-named artifacts
      - name: Upload EXE+DLL artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f #v6.0.0 25-12
        with:
          name: mptrsz_exe+dll_win_${{matrix.cache_key}}
          path: |
            asset/${{matrix.asset_exe}}.exe
            asset/${{matrix.asset_dll}}.dll
